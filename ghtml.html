<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Ses Kaydedici</title>
</head>
<body>
    <div style="text-align: center; margin-top: 50px;">
        <button id="recordButton" style="font-size: 20px; padding: 10px 20px;">🎤 Kayda Başla</button>
        <p id="statusText" style="font-size: 18px; margin-top: 20px;">Hazır</p>
        <p id="resultText" style="font-size: 20px; font-weight: bold; color: darkblue;"></p>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];

        const recordButton = document.getElementById('recordButton');
        const statusText = document.getElementById('statusText');
        const resultText = document.getElementById('resultText');

        recordButton.addEventListener('click', async () => {
            try {
                if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        statusText.textContent = "Yükleniyor ve analiz ediliyor...";
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

                        const formData = new FormData();
                        formData.append('audio', audioBlob, 'kayit.webm');

                        try {
                            const response = await fetch('http://localhost:5000/convert', {
                                method: 'POST',
                                body: formData
                            });

                            if (!response.ok) {
                                throw new Error('Sunucudan geçerli yanıt alınamadı.');
                            }

                            const text = await response.text();
                            resultText.textContent = text;
                            statusText.textContent = "Yanıt alındı:";

                            // Metni sesli oku
                            const utterance = new SpeechSynthesisUtterance(text);
                            utterance.lang = 'tr-TR';
                            window.speechSynthesis.speak(utterance);

                        } catch (error) {
                            statusText.textContent = 'Hata: ' + error.message;
                        }

                        audioChunks = [];
                    };

                    mediaRecorder.start();
                    statusText.textContent = "Kaydediliyor...";
                    recordButton.textContent = '⏹ Kaydı Durdur';
                } else if (mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    recordButton.textContent = '🎤 Kayda Başla';
                    statusText.textContent = "İşleniyor...";
                }
            } catch (error) {
                alert('Mikrofon hatası: ' + error.message);
            }
        });
    </script>
</body>
</html>
